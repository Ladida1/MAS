<!DOCTYPE html>
<html>
<head>
<title>MAS Web UI</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="jquery.mobile-1.4.4.min.css" />
<script src="jquery-1.11.1.min.js"></script>
<script src="jquery.mobile-1.4.4.min.js"></script>
<script>

$(document).ready(function(){
	$.getJSON("/groups",function(groups){
		$.each(groups, function(i, group){
			listGroup(group);
		});		
	});
	$.getJSON("/devices",function(devices){
		$.each(devices, function(i, device){
			listDevice(device);
		});
	});
	$.get("/configuration",function(config){
		$("#config_area").val(config);
	});
	$.get("/log",function(log){
		$("#log_area").text(log);
	});
	$( "#save_config" ).on( "click", function() {
		$.ajax({
			type : "POST",
			dataType : "text",
			url : "/configuration",
			data : $("#config_area").val(),
			success : function(response) {
				$("#popupSaveOk").popup('open');
				setTimeout(function() {
					$("#popupSaveOk").popup("close");
					}, 2000);
			},
			error : function(xhr, status, error) {
				$("#popupSaveErrorMsg").html(xhr.responseText.replace(/(\n)+/g, '<br>'));
				$("#popupSaveError").popup('open');
			}
		});
	});
	$( "#update_log" ).on( "click", function() {
			$("#log_area").text(log);
		});
});

function listDevice(device){
	device_element =
	'<li>' +
	'	<h1 align="center">' + device.name + '</h1>';
	
	if(device.supports_on_off){
		device_element +=
		'<fieldset class="ui-grid-a">'+
		'	<div class="ui-block-a"><button class="ui-btn ui-corner-all ui-btn-a ui-shadow" onclick="turnOn('+device.id+')">On</button></div>'+
		'	<div class="ui-block-b"><button class="ui-btn ui-corner-all ui-btn-a ui-shadow" onclick="turnOff('+device.id+')">Off</button></div>'+
		'</fieldset>';		
	}
	if(device.supports_dim){
		device_element +=
		'<input type="range" id="dim'+device.id+'" value="'+device.dim_level_last+'" min="'+device.dim_level_min+'" max="'+device.dim_level_max+'" data-highlight="true" onchange="dim(this.value,'+device.id+')">';
	}

	device_element += "</li>";

	$("#device_list").append(device_element);
	if(device.supports_dim){
		$("#device_list").trigger("create");
	}
}

function turnOn(id){
	$.getJSON("/device/"+id+"/on",function(retVal){
		// TODO
	});
}

function turnOff(id){
	$.getJSON("/device/"+id+"/off",function(retVal){
		// TODO
	});
}

var dimming_lock = false;
function dim(value, id){
	// Since the slider input will give events continuously we have a lock
	// that avoids sending JSON request each time and lock up the server.
	if (dimming_lock == false) {
		dimming_lock = true;
		$.getJSON("/device/"+id+"/dim/"+value,function(retVal){
			dimming_lock = false;
		});	
	}
}

function listGroup(group){
	group_element =
	'<li>' +
	'	<h1 align="center">(G) ' + group.name + '</h1>';
	
	if(group.supports_on_off){
		group_element +=
		'<fieldset class="ui-grid-a">'+
		'	<div class="ui-block-a"><button class="ui-btn ui-corner-all ui-btn-a ui-shadow" onclick="turnOnGroup('+group.id+')">On</button></div>'+
		'	<div class="ui-block-b"><button class="ui-btn ui-corner-all ui-btn-a ui-shadow" onclick="turnOffGroup('+group.id+')">Off</button></div>'+
		'</fieldset>';		
	}
	if(group.supports_dim){
		group_element +=
		'<input type="range" id="dim_group'+group.id+'" value="0" min="'+group.dim_level_min+'" max="'+group.dim_level_max+'" data-highlight="true" onchange="dimGroup(this.value,'+group.id+')">';
	}

	group_element += "</li>";

	$("#group_list").append(group_element);
}

function turnOnGroup(id){
	$.getJSON("/group/"+id+"/on",function(retVal){
		// TODO
	});
}

function turnOffGroup(id){
	$.getJSON("/group/"+id+"/off",function(retVal){
		// TODO
	});
}

var dimming_group_lock = false;
function dimGroup(value, id){
	// Since the slider input will give events continuously we have a lock
	// that avoids sending JSON request each time and lock up the server.
	if (dimming_group_lock == false) {
		dimming_group_lock = true;
		$.getJSON("/group/"+id+"/dim/"+value,function(retVal){
			dimming_group_lock = false;
		});	
	}
}

</script>
</head>
<body>

<!-- Device page -->
<div data-role="page" id="devices">

	<div data-role="panel" id="menu">
		<a href="#configuration" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-gear" data-rel="close">Configuration</a>
		<a href="#log" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-bars" data-rel="close">Log</a>
		<a href="#header" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-back" data-rel="close">Back</a>
	</div>

	<div data-role="header" id="header">
		<a href="#menu" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-bars ui-btn-icon-notext">Menu</a>
		<h1>Groups / Devices</h1>
	</div>

	<div role="main" class="ui-content">
		<ul data-role="listview" id="group_list">
			<!-- Dynamically created group list items goes here -->
		</ul>
		<br><br>
		<ul data-role="listview" id="device_list">
			<!-- Dynamically created device list items goes here -->
		</ul>		
	</div>	
		
	<div data-role="footer">
		<!--<h4>Footer</h4>-->
	</div>
</div><!-- /page -->

<!-- Configuration page -->
<div data-role="page" id="configuration">

	<div data-role="panel" id="menu_config">
		<a href="#devices" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-home" data-rel="close">Groups/Devices</a>
		<a href="#log" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-bars" data-rel="close">Log</a>
		<a href="#header" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-back" data-rel="close">Back</a>
	</div>

	<div data-role="header" id="header">
		<a href="#menu_config" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-bars ui-btn-icon-notext">Menu</a>
		<h1>Configuration</h1>
	</div>
	
	<div role="main" class="ui-content">
		<a data-role="button" data-icon="check" id="save_config">Save</a>
		<!-- Configuration is filled here -->
		<textarea id="config_area"></textarea>
	</div>	
		
	<div data-role="footer">
		<!--<h4>Footer</h4>-->
	</div>
	
	<!-- Popup dialog: Saved successfully -->
	<div data-role="popup" id="popupSaveOk">
		<p>Successfully saved</p>
	</div>
	
	<!-- Popup dialog: Save error -->
	<div data-role="popup" id="popupSaveError" class="ui-content" data-theme="e" style="max-width:350px; background-color: wheat;">
		<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-left">Close</a>
		<p><strong>ERROR!</strong></p>
        <p id="popupSaveErrorMsg">Reason not known</p>
	</div>
</div><!-- /page -->

<!-- Log page -->
<div data-role="page" id="log">

	<div data-role="panel" id="menu_log">
		<a href="#devices" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-home" data-rel="close">Groups/Devices</a>
		<a href="#configuration" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-gear" data-rel="close">Configuration</a>
		<a href="#header" class="ui-btn ui-shadow ui-btn-icon-right ui-icon-back" data-rel="close">Back</a>
	</div>

	<div data-role="header" id="header">
		<a href="#menu_log" class="ui-btn ui-shadow ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-bars ui-btn-icon-notext">Menu</a>
		<h1>Log</h1>
	</div>
	
	<div role="main" class="ui-content">
		<a data-role="button" data-icon="refresh" id="update_log">Update</a>
		<!-- Log is filled here -->
		<pre id="log_area"></pre>
	</div>	
		
	<div data-role="footer">
		<!--<h4>Footer</h4>-->
	</div>
</div><!-- /page -->

</body>
</html>